<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Inactive Paid Users</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .description {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .description h3 {
            color: #495057;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .description p {
            color: #6c757d;
            margin-bottom: 15px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-bottom: 20px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .loading {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
        }
        .user-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .user-item strong {
            color: #495057;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Inactive Paid Users</h1>

        <div class="description">
            <h3>What This Tool Does</h3>
            <p>This tool finds all users who have payment data (last payment date, customer ID, or subscription ID) but still show as "inactive" status. It automatically updates them to "active" status with the correct plan type.</p>

            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> This tool only affects users who have actually paid but are incorrectly showing as inactive. It will not activate users who haven't paid.
            </div>
        </div>

        <button id="fixButton" onclick="fixInactiveUsers()">üöÄ Fix All Inactive Paid Users</button>

        <div id="loading" class="loading">
            <strong>üîÑ Processing...</strong><br>
            Finding and fixing inactive users who have paid. This may take a moment...
        </div>

        <div id="result" class="result">
            <strong>‚úÖ Success!</strong><br>
            <span id="resultMessage"></span>
        </div>

        <div id="error" class="error">
            <strong>‚ùå Error:</strong><br>
            <span id="errorMessage"></span>
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalFound">0</div>
                <div class="stat-label">Users Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="fixedCount">0</div>
                <div class="stat-label">Users Fixed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successRate">0%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>

        <div id="userList" class="user-list" style="display: none;">
            <h4>üìã Fixed Users:</h4>
            <div id="userItems"></div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
                <h4 style="color: #856404; margin: 0 0 10px 0;">üö® If CORS Error Occurs:</h4>
                <div style="text-align: left;">
                    <strong>Option 1 - PowerShell Script:</strong><br>
                    <code style="background: #f8f9fa; padding: 5px; border-radius: 3px;">.\fix-inactive-users.ps1</code><br><br>

                    <strong>Option 2 - Batch File:</strong><br>
                    <code style="background: #f8f9fa; padding: 5px; border-radius: 3px;">fix-inactive-users.bat</code><br><br>

                    <strong>Option 3 - Browser Console:</strong><br>
                    Open DevTools (F12) ‚Üí Console ‚Üí Paste contents of <code>browser-console-fix.js</code>
                </div>
            </div>

            <a href="verify-stripe-webhook.html" style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none; margin-right: 10px;">‚Üê Back to Webhook Test</a>
            <a href="webhook-test.html" style="background: #28a745; color: white; padding: 10px 20px; border-radius: 6px; text-decoration: none;">Full Test Suite</a>
        </div>
    </div>

    <script>
        async function fixInactiveUsers() {
            const fixButton = document.getElementById('fixButton');
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            const error = document.getElementById('error');
            const stats = document.getElementById('stats');
            const userList = document.getElementById('userList');

            // Hide all sections
            loading.style.display = 'none';
            result.style.display = 'none';
            error.style.display = 'none';
            stats.style.display = 'none';
            userList.style.display = 'none';

            // Show loading and disable button
            loading.style.display = 'block';
            fixButton.disabled = true;
            fixButton.textContent = 'üîÑ Processing...';

            try {
                console.log('üåê Attempting to call API...');
                const response = await fetch('https://clipsmartai.com/api-node/api/v1/payments/fix-inactive-users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });

                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üì¶ Response data:', data);

                if (data.success) {
                    // Show success result
                    result.style.display = 'block';
                    document.getElementById('resultMessage').textContent = data.message;

                    // Show stats
                    stats.style.display = 'grid';
                    document.getElementById('totalFound').textContent = data.totalFound;
                    document.getElementById('fixedCount').textContent = data.fixedCount;
                    document.getElementById('successRate').textContent =
                        data.totalFound > 0 ? Math.round((data.fixedCount / data.totalFound) * 100) + '%' : '0%';

                    // Show user list if there are results
                    if (data.results && data.results.length > 0) {
                        userList.style.display = 'block';
                        const userItems = document.getElementById('userItems');

                        data.results.forEach(user => {
                            const userDiv = document.createElement('div');
                            userDiv.className = 'user-item';
                            userDiv.innerHTML = `
                                <strong>${user.email}</strong><br>
                                <small>ID: ${user.userId}</small><br>
                                <small>Status: ${user.oldStatus} ‚Üí ${user.newStatus}</small><br>
                                <small>Plan: ${user.planType}</small>
                            `;
                            userItems.appendChild(userDiv);
                        });
                    }

                    console.log('‚úÖ Fix completed successfully:', data);
                } else {
                    // Show error
                    error.style.display = 'block';
                    document.getElementById('errorMessage').textContent = data.message || 'Unknown error occurred';
                    console.error('‚ùå Fix failed:', data);
                }

            } catch (err) {
                console.error('‚ùå Network error:', err);

                // Show CORS-specific error message
                if (err.message.includes('CORS') || err.message.includes('Access-Control-Allow-Origin')) {
                    error.style.display = 'block';
                    document.getElementById('errorMessage').innerHTML = `
                        <strong>CORS Error:</strong> Cannot access API from local file.<br><br>
                        <strong>Alternative Solutions:</strong><br>
                        1. Use browser console: Open DevTools (F12) ‚Üí Console tab<br>
                        2. Run this command in terminal:<br>
                        <code style="background: #f8f9fa; padding: 5px; border-radius: 3px; display: block; margin: 10px 0;">
                        curl -X POST https://clipsmartai.com/api-node/api/v1/payments/fix-inactive-users -H "Content-Type: application/json"
                        </code><br>
                        3. Open the HTML file through a local server instead of file://
                    `;
                } else {
                    error.style.display = 'block';
                    document.getElementById('errorMessage').textContent = `Network error: ${err.message}`;
                }
            } finally {
                // Hide loading and re-enable button
                loading.style.display = 'none';
                fixButton.disabled = false;
                fixButton.textContent = 'üöÄ Fix All Inactive Paid Users';
            }
        }

        // Auto-scroll to results when they appear
        function scrollToResults() {
            const result = document.getElementById('result');
            const error = document.getElementById('error');
            const stats = document.getElementById('stats');

            if (result.style.display === 'block' || error.style.display === 'block' || stats.style.display === 'grid') {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        // Check for results every second
        setInterval(scrollToResults, 1000);
    </script>
</body>
</html>
